#!/bin/bash
set -e

BASE="$HOME/hashburst"
SCRIPTS="$BASE/scripts"
MONITOR="$SCRIPTS/hashburst_monitor.sh"
WRAPPER="$SCRIPTS/hashburst_wrapper.sh"
DAILY="$SCRIPTS/daily_hashburst_check.sh"
LOG="$SCRIPTS/hashburst.log"

BOT_TOKEN="8457028859:AAG7PKSBamakiZts_JZCRqcqOmL0QDtHnaw"
CHAT_IDS=("1308666019" "1060780677")

SCREEN_MINER="hashburst_live"
SCREEN_MONITOR="hashburst_monitor"

CHECK_INTERVAL=10
REFRESH_INTERVAL=10800   # 3 hours

mkdir -p "$SCRIPTS"

echo "Cleaning old sessions..."
pkill -f hashburst_wrapper.sh || true
pkill -f hashburst_monitor.sh || true
screen -ls | grep -E "$SCREEN_MINER|$SCREEN_MONITOR" | awk '{print $1}' | xargs -r -n1 screen -S {} -X quit || true
(crontab -l 2>/dev/null | grep -v 'daily_hashburst_check.sh') | crontab -

########################################
# WRAPPER
########################################
cat << 'EOF' > "$WRAPPER"
#!/bin/bash
hashburst start
EOF
chmod +x "$WRAPPER"

########################################
# MONITOR
########################################
cat << EOF > "$MONITOR"
#!/bin/bash

BOT_TOKEN="$BOT_TOKEN"
CHAT_IDS=("1308666019" "1060780677")
SCREEN_NAME="$SCREEN_MINER"
WRAPPER="$WRAPPER"
LOG_FILE="$LOG"

CHECK_INTERVAL=$CHECK_INTERVAL
REFRESH_INTERVAL=$REFRESH_INTERVAL

LAST_REFRESH=\$(date +%s)

send_telegram(){
 for ID in "\${CHAT_IDS[@]}"; do
  curl -s -X POST "https://api.telegram.org/bot\${BOT_TOKEN}/sendMessage" \
  -d chat_id="\$ID" \
  -d text="\$1" >/dev/null
 done
}

start_miner(){
 if ! screen -list | grep -q "\$SCREEN_NAME"; then
  screen -dmS "\$SCREEN_NAME" bash -c "\$WRAPPER | tee -a \$LOG_FILE"
  sleep 5
  send_telegram "Miner started on \$(hostname)"
 fi
}

refresh_miner(){
 if screen -list | grep -q "\$SCREEN_NAME"; then
  screen -S "\$SCREEN_NAME" -p 0 -X stuff "q"
  screen -S "\$SCREEN_NAME" -p 0 -X stuff \$'\\n'
  sleep 2
  screen -S "\$SCREEN_NAME" -p 0 -X stuff "1"
  screen -S "\$SCREEN_NAME" -p 0 -X stuff \$'\\n'
  sleep 2
  send_telegram "Miner refreshed (3h auto) on \$(hostname)"
 fi
}

send_telegram "Monitor started on \$(hostname)"
start_miner

while true; do

 if ! pgrep -f hashburst >/dev/null; then
  send_telegram "Miner crashed, restarting..."
  start_miner
 fi

 NOW=\$(date +%s)

 if (( NOW - LAST_REFRESH >= REFRESH_INTERVAL )); then
  refresh_miner
  LAST_REFRESH=\$NOW
 fi

 sleep \$CHECK_INTERVAL
done
EOF

chmod +x "$MONITOR"

########################################
# DAILY CHECK
########################################
cat << EOF > "$DAILY"
#!/bin/bash
BOT="$BOT_TOKEN"
HOST=\$(hostname)
STATUS="Stopped"

if pgrep -f hashburst >/dev/null; then
 STATUS="Running"
fi

for ID in 1308666019 1060780677
do
 curl -s -X POST "https://api.telegram.org/bot\$BOT/sendMessage" \
 -d chat_id="\$ID" \
 -d text="Daily Status: \$STATUS on \$HOST (\$(date))" >/dev/null
done
EOF

chmod +x "$DAILY"

(crontab -l 2>/dev/null; echo "30 6 * * * $DAILY >> $SCRIPTS/cron.log 2>&1") | sort -u | crontab -

screen -dmS "$SCREEN_MONITOR" bash -c "$MONITOR"

echo "Installed with 3-hour auto refresh"
